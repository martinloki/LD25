<!doctype html>
<html>
	<head>
		<title>Granny's Gummies - LD25</title>
		<link href="/stylesheets/LD25.css" media="all" rel="stylesheet" type="text/css"/>
		<script language="javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js" type="text/javascript"></script>
	</head>
	<body>
		<h1>Granny's Gummies</h1>
		<script type='text/javascript'>
			var CANVAS_WIDTH=800;
			var CANVAS_HEIGHT=600;
			var FPS=30;
			var textX=50;
			var textY=50;
			
			var canvasElement=$("<canvas width='"+CANVAS_WIDTH+"' height='"+CANVAS_HEIGHT+"' style='border:1px solid #000000;'></canvas>");
			var canvas=canvasElement.get(0).getContext("2d");
			
			var bg_image = new Image();
			var kid_image = new Image();
			
			var KID_RADIUS=30;
			
			var rooms=[];
			var portals=[];
			var kids=[];
			
			function Room(Index){
				Index = Index || {};
				Index.width=Index.x1-Index.x0
				Index.height=Index.y1-Index.y0
				Index.centerX=(Index.x0+Index.x1)/2;
				Index.centerY=(Index.y0+Index.y1)/2;
				
				Index.getName = function(){
					return Index.roomName;
				};
				
				Index.getCX = function(){
					return Index.centerX;
				};
				
				Index.getCY = function(){
					return Index.centerY;
				};
				
				Index.getX = function(){
					return Index.x0;
				};
				
				Index.getY = function(){
					return Index.y0;
				};
				
				Index.getWidth = function(){
					return Index.width;
				};
				
				Index.getHeight = function(){
					return Index.height;
				};
				
				Index.draw = function(){
					//canvas.fillStyle=Index.thisColor;
					//canvas.fillRect(Index.x0,Index.y0,Index.width,Index.height);
				};
				
				Index.isInRoom=function(x,y){			
					return x>=Index.x0 && x<=Index.x1 && y>=Index.y0 && y<=Index.y1;					
				};

				
				return Index;
			};
			
			function Portal(Index){
				goesToHall=(Index.room0==0||Index.room1==0);
				Index = Index || {};
				
				Index.getX=function(){return Index.x;};
				Index.getY=function(){return Index.y;};
				
				return Index;
			};
			
			
			function Kid(Index){
				Index = Index || {};
				
				Index.baseVel=10;
				Index.width=KID_RADIUS;
				Index.height=KID_RADIUS;
				Index.energy=Math.random()*25;
				Index.focus=Math.random()*50+25;
				Index.sugar=0;
				Index.crashETA=0;
				Index.timeLeftInRoom=400;
				Index.velX=Index.baseVel*(Index.sugar+1)/10*(Math.random()*2-1);
				Index.velY=Index.baseVel*(Index.sugar+1)/10*(Math.random()*2-1);
				Index.roomIndex=Math.floor(Math.random()*7+1);
				Index.currentRoomObj=rooms[Index.roomIndex];  //Hall is 0 and outside is 9
				//Index.currentRoomObj=rooms[0];
				Index.currentRoom=Index.currentRoomObj.getName();
				Index.nextRoomIndex=9;
				
				//spawn away from the walls
				Index.xmin=Index.currentRoomObj.getX()+5;
				Index.xmax=Index.currentRoomObj.getX()+Index.currentRoomObj.getWidth()-Index.width-5;
				Index.ymin=Index.currentRoomObj.getY()+5;
				Index.ymax=Index.currentRoomObj.getY()+Index.currentRoomObj.getHeight()-Index.height-5;
				
				Index.x=Math.random()*(Index.xmax-Index.xmin)+Index.xmin;
				Index.y=Math.random()*(Index.ymax-Index.ymin)+Index.ymin;
				
				Index.inHouse=rooms[0].isInRoom(Index.x,Index.y);
				
				Index.draw=function(){
					canvas.drawImage(kid_image, Index.x,Index.y);
					canvas.fillStyle=Index.color;
					canvas.fillText(Index.name,Index.x,Index.y);					
				};
								
				Index.update = function() {				
					if(Index.timeLeftInRoom>=0){
						Index.x+=Index.velX;
						Index.y+=Index.velY;
						Index.timeLeftInRoom-=1
						if(Index.x<Index.currentRoomObj.x0||(Index.x+Index.width)>Index.currentRoomObj.x1){
							Index.velX*=-1;
							Index.x+=Index.velX*2;
						}
						if(Index.y<Index.currentRoomObj.y0||(Index.y+Index.height)>Index.currentRoomObj.y1){
							Index.velY*=-1;
							Index.y+=Index.velY*2;
						}
					}else if(Index.timeLeftInRoom!=-999){
						Index.doorChoice=Math.round(Math.random());
						Index.x=portals[Index.currentRoomObj.dList[Index.doorChoice]].getX()-Index.width/2;
						Index.y=portals[Index.currentRoomObj.dList[Index.doorChoice]].getY()-Index.height/2;
						Index.timeLeftInRoom=-999;
						Index.nextRoomIndex=Math.floor(Math.random()*7+1);
						//Index.currentRoomObj=rooms[Index.nextRoomIndex];
					}
					
					//Index.inHouse=rooms[0].isInRoom(Index.x,Index.y);
					
					//Index.currentRoom="ESCAPED!!!!";
					//rooms.forEach(function(room) {
					//	if(room.isInRoom(Index.x,Index.y)){
					//		Index.currentRoom=room.getName();
					//		Index.currentRoomObj=room;
					//	}
					//});
					
				};
				
				Index.getRoom = function(){
					return Index.currentRoom;
				};
				
				Index.getSugar = function(){
					return Index.sugar;
				};
				
				Index.getName = function(){
					return Index.name;
				};
				
				Index.drawPanel = function(x,y){
					canvas.fillText(Index.name,x,y);
					canvas.fillText("Location:",x+15,y+10);
					canvas.fillText("Sugar Level:",x+15,y+20);					
					canvas.fillText(Index.currentRoom,x+80,y+10);
					canvas.fillText(Index.sugar,x+80,y+20);
					
					//------½DEBUGGING½-----
					
					debugStrings=new Array
					debugStrings.push(String("In House:"+Index.inHouse));
					debugStrings.push("Time Left:"+Index.timeLeftInRoom);
					debugStrings.push("nextRoomID:"+Index.nextRoomIndex);
					debugStrings.push("nextRoomName:"+rooms[Index.nextRoomIndex].getName());
					debugStrings.push("DoorChoice:"+Index.doorChoice);
					
					debug_y=y+40;
					canvas.fillText("Debug:",x+15,debug_y);
					$.each(debugStrings, function() {
						canvas.fillText(this,x+80,debug_y);
						debug_y+=10;
					}); 
				};
				
				return Index;				
				
			};
			
			function init(){
				bg_image.src = 'images/background.png';
				kid_image.src = 'images/kid.png';
				
				rooms.push(Room({roomName:"Halls",			x0:330,y0:0,	x1:667,y1:600,	dList:[0,3,4,7,8,10,11],	thisColor:"#FFF"}));
				rooms.push(Room({roomName:"Kid's Room",		x0:330,y0:0,	x1:475,y1:135,	dList:[0,1],	thisColor:"#00F"}));
				rooms.push(Room({roomName:"Kid's Bathroom",	x0:330,y0:135,	x1:475,y1:200,	dList:[1,2],	thisColor:"#0F0"}));
				rooms.push(Room({roomName:"Office",			x0:330,y0:200,	x1:475,y1:335,	dList:[2,3],	thisColor:"#0FF"}));
				rooms.push(Room({roomName:"Kitchen",		x0:330,y0:335,	x1:475,y1:482,	dList:[4,5],	thisColor:"#F00"}));
				rooms.push(Room({roomName:"Dining Room",	x0:330,y0:482,	x1:475,y1:600,	dList:[5,6],	thisColor:"#F0F"}));
				
				rooms.push(Room({roomName:"Living Room",		x0:475,y0:385,	x1:667,y1:600,	dList:[6,7],	thisColor:"#888"}));
				rooms.push(Room({roomName:"Parent's Bathroom",	x0:524,y0:225,	x1:667,y1:338,	dList:[8,9],	thisColor:"#F55"}));
				rooms.push(Room({roomName:"Parent's Room",		x0:524,y0:0,	x1:667,y1:225,	dList:[9,10],	thisColor:"#FF0"}));
				rooms.push(Room({roomName:"Outside",			x0:667,y0:0,	x1:800,y1:600,	dList:[11],		thisColor:"#FF0"}));
				

				portals.push(Portal({x:475,y:98	,room0:1,room1:0}));	//0 - kids to hall
				portals.push(Portal({x:370,y:138,room0:1,room1:2}));	//1 - kids to kids bath
				portals.push(Portal({x:370,y:200,room0:2,room1:3}));	//2 - kids bath to office
				portals.push(Portal({x:475,y:230,room0:3,room1:0}));	//3 - office to hall
				portals.push(Portal({x:475,y:360,room0:4,room1:0}));	//4 - hall to kitchen
				portals.push(Portal({x:410,y:480,room0:4,room1:5}));	//5 - kitchen to dining
				portals.push(Portal({x:475,y:540,room0:5,room1:6}));	//6 - dining to living
				portals.push(Portal({x:535,y:385,room0:6,room1:0}));	//7 - living to hall
				portals.push(Portal({x:525,y:275,room0:7,room1:0}));	//8 - hall to master bath
				portals.push(Portal({x:610,y:225,room0:7,room1:8}));	//9 - master bath to master
				portals.push(Portal({x:475,y:275,room0:8,room1:0}));	//10 - master to hall
				portals.push(Portal({x:666,y:360,room0:9,room1:0}));	//11 - hall to world
								
				kids.push(Kid({name:"Thing 1",color:"#F0F"}));
				kids.push(Kid({name:"Thing 2",color:"#0F0"}));				
			}
			
			setInterval(function(){
					update();
					draw();
				},1000/FPS
			);

			function update(){
				textX+=1;
				textY+=1;
				kids.forEach(function(kid) {
					kid.update();
				});
			}
			
			function draw(){
				canvas.clearRect(0,0,CANVAS_WIDTH,CANVAS_HEIGHT);
				canvas.drawImage(bg_image, 0, 0);
				canvas.fillStyle="#000";
				rooms.forEach(function(room) {
					room.draw();
					canvas.fillStyle="#000";
					canvas.fillText(room.getName(),room.getX()+5,room.getY()+10);
				});
				
				nextPanelX=50;
				nextPanelY=50;
				kids.forEach(function(kid) {		
						kid.draw();
						kid.drawPanel(nextPanelX,nextPanelY);
						nextPanelY+=150;
				});               
			}

			init()
			canvasElement.appendTo('body');
			
		</script>
	</body>
</html>